function LocalDataStorage(e){function t(e){for(var t=[],a=0;a<c.length;a++)c[a].LDS_DELETED===!1&&n(c[a],e)&&t.push(a);return t}function n(e,t){if(void 0===t||null===t||"function"!=typeof t)return!0;var n=t.call(e);return n}function a(e,t){for(var n={},a=0;a<t.length;a++){var r=t[a];"function"!==r.type&&(n[r.name]=e[r.name])}return n}function r(e,t,n,a){var o=n[a];return"ASC"===o.direction.toUpperCase()&&e[o.name]<t[o.name]||"DESC"===o.direction.toUpperCase()&&e[o.name]>t[o.name]?-1:"ASC"===o.direction.toUpperCase()&&e[o.name]>t[o.name]||"DESC"===o.direction.toUpperCase()&&e[o.name]<t[o.name]?1:a+1<n.length?r(e,t,n,a+1):0}function o(e){return"[object Array]"===Object.prototype.toString.call(e)?!0:!1}function l(e,t){(void 0===t||null===t)&&(t=this);var n=null;"afterDataChanged"===e&&null!==i&&void 0!==i&&(n=i),n.call(t)}function i(){d&&console.log("Event afterDataChanged started"),g&&g.afterDataChanged(this)}var u="",s=[],c=[],d=!1,f=0,g=null;this.getId=function(){return u},this.getStructure=function(){return s},this.isDebug=function(){return d},this.getRawRows=function(){return c},this.getPersistencyController=function(){return g},this.setDebug=function(e){d=e},this.addColumn=function(e){if(d&&console.info("LocalDataStorage.addColumn()"),void 0===e.name||null===e.name)throw new Error("Column name can not be null");if("LDS_"===e.name.substring(0,4))throw new Error('Columnprefix "LDS_" is reserved for internal functions');for(var t=0;t<s.length;t++){var n=s[t];if(n.name===e.name)throw new Error('Column "'+e.name+'" already exists')}if(void 0===e.type&&(e.type="string"),"string"!==e.type&&"number"!==e.type&&"boolean"!==e.type)throw new Error('Column "'+e.name+'" does not support datatype "'+e.type+'"');if(void 0!==e.defaultvalue&&null!==e.defaultvalue?"string"===e.type?e.defaultvalue=this.validateValueString(e.defaultvalue):"number"===e.type?e.defaultvalue=this.validateValueNumber(e.defaultvalue):"boolean"===e.type&&(e.defaultvalue=this.validateValueBoolean(e.defaultvalue)):e.defaultvalue=null,void 0!==e.nullable&&null!==e.nullable?e.nullable!==!0&&e.nullable!==!1&&(e.nullable=!0):e.nullable=!0,c.length>0&&null===e.defaultvalue&&!e.nullable)throw new Error('Column "'+e.name+'" is not nullable, and defaultvalue is null.');if(s.push({name:e.name,type:e.type,defaultvalue:e.defaultvalue,nullable:e.nullable}),c.length>0)for(t=0;t<c.length;t++)c[t].LDS_DELETED||(c[t][e.name]=e.defaultvalue);return d&&console.info('Column "'+e.name+'" with type "'+e.type+'" added successfully'),!0},this.addRow=function(e){d&&console.info("LocalDataStorage.addRow()");var t={};if(t.LDS_ROWGUID=this.createRowGuid(),t.LDS_ROWVERSION=this.getCurrentRowVersion(!0),t.LDS_DELETED=!1,void 0!==e&&null!==e)for(var n=0;n<s.length;n++){var a=s[n];void 0!==e[a.name]?"string"===a.type?t[a.name]=this.validateValueString(e[a.name]):"number"===a.type?t[a.name]=this.validateValueNumber(e[a.name]):"boolean"===a.type&&(t[a.name]=this.validateValueBoolean(e[a.name])):a.nullable===!1&&null===a.defaultvalue?console.error('Column "'+a.name+'" can not be null'):t[a.name]=a.defaultvalue}d&&console.info(t),c.push(t);try{l("afterDataChanged",this)}catch(r){d&&console.error(r.message)}return!0},this.select=function(e,t,n,a){return this.selectRow(e,t,n,a)},this.selectRow=function(e,n,l){var i=[],u=[];l=l||0,void 0===view&&(view=null);for(var f=t(e,view),g=0;g<f.length;g++)u.push(c[f[g]]);if(void 0!==n&&null!==n){if(!o(n)){var h=[];h.push(n),n=h}d&&console.log(n),u.sort(function(e,t){return r(e,t,n,0)})}for(var v=0;v<u.length;v++)(0===l||l>v)&&i.push(a(u[v],s));return i},this.update=function(e,t){return this.updateRow(e,t)},this.updateRow=function(e,n){if(d&&console.info("LocalDataStorage.updateRow()"),!n)throw new Error("data can not be null");for(var a=t(e),r=0,o=0,i=0;i<a.length;i++){for(var u=!1,f=0;f<s.length;f++){var g=n[s[f].name],h=s[f];void 0!==g&&(null===g?s[f].nullable?(c[a[i]][s[f].name]=null,u=!0):console.error('Column "'+h.name+'" can not be null'):"string"===h.type?(c[a[i]][s[f].name]=this.validateValueString(g),u=!0):"number"===h.type?(c[a[i]][s[f].name]=this.validateValueNumber(g),u=!0):"boolean"===h.type&&(c[a[i]][s[f].name]=this.validateValueBoolean(g),u=!0))}u&&(0===o&&(o=this.getCurrentRowVersion(!0)),c[a[i]].LDS_ROWVERSION=o,r++)}if(r>0)try{l("afterDataChanged",this)}catch(v){d&&console.error(v.message)}return r},this.deleteRow=function(e){d&&console.info("LocalDataStorage.deleteRow()");for(var n=t(e),a=0,r=0,o=0;o<n.length;o++){var i={};0===r&&(r=this.getCurrentRowVersion(!0)),i.LDS_ROWGUID=c[n[o]].LDS_ROWGUID,i.LDS_ROWVERSION=r,i.LDS_DELETED=!0,c[n[o]]=i,a++}if(a>0)try{l("afterDataChanged",this)}catch(u){d&&console.error(u.message)}return a},this.validateValueString=function(e){return String(e)},this.validateValueNumber=function(e){var t=parseInt(e);return isNaN(t)&&(t=0),t},this.validateValueBoolean=function(e){return"string"==typeof e?e="true"===e.toLowerCase()?!0:"false"===e.toLowerCase()?!1:null:"number"==typeof e?e=1===e?!0:0===e?!1:null:"object"==typeof e&&(e=null),e},this.getCurrentRowVersion=function(e){return e?++f:f},this.createRowGuid=function h(){function e(e){var t=(Math.random().toString(16)+"000000000").substr(2,8);return e?"-"+t.substr(0,4)+"-"+t.substr(4,4):t}return e()+e(!0)+e(!0)+e()},this.initiate=function(e){if(void 0!==e&&null!==e&&(void 0!==e.id&&null!==e.id&&(u=e.id),void 0!==e.debug&&null!==e.debug&&(d=e.debug),void 0!==e.databasechangeversion&&null!==e.databasechangeversion&&(f=e.databasechangeversion),void 0!==e.enablepersistency&&null!==e.enablepersistency&&e.enablepersistency===!0&&(g=new LocalStoragePersistencyController({debug:e.debug}))),d&&console.info("LocalDataStorage.initiate()"),g)try{var t=g.onInitiate(this);c=t.rows,s=t.structure,f=t.databasechangeversion}catch(n){d&&console.error(n.message)}},this.initiate(e)}function LocalStoragePersistencyController(e){var t=null,n=!1,a=!1;this.isDebug=function(){return a},this.setDebug=function(e){a=e},this.isDataLoadedSucessfully=function(){return n},this.onInitiate=function(e){a&&console.log("LocalStoragePersistencyController.onInitiate");var r,o,l;void 0!==window.localStorage&&null!==window.localStorage&&(t=window.localStorage);var i=t.getItem("LDS_"+e.getId()+"_STRUCTURE"),u=t.getItem("LDS_"+e.getId()+"_ROWS"),s=t.getItem("LDS_"+e.getId()+"_SETTINGS");if(null===i||null===u||null===s)throw new Error("Stored DB-Data are not available");try{r=JSON.parse(i),o=JSON.parse(u),l=JSON.parse(s)}catch(c){throw new Error("Invalid Data - could not reinitialize DB Data")}var d=l.databasechangeversion;return null===t?null:(n=!0,{structure:r,rows:o,databasechangeversion:d})},this.afterDataChanged=function(e){return a&&console.log("LocalStoragePersistencyController.afterDataChanged"),null!==t?(t.setItem("LDS_"+e.getId()+"_STRUCTURE",JSON.stringify(e.getStructure())),t.setItem("LDS_"+e.getId()+"_ROWS",JSON.stringify(e.getRawRows())),t.setItem("LDS_"+e.getId()+"_SETTINGS",JSON.stringify({databasechangeversion:e.getCurrentRowVersion()})),!0):!1},this.initiate=function(e){void 0!==e&&null!==e&&void 0!==e.debug&&null!==e.debug&&(a=e.debug)},this.initiate(e)}module.exports=LocalDataStorage;