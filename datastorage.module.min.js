/*
@license
LocalDataStorage
https://github.com/Zearom/LocalDataStorage
Copyright (c) 2013-2014 Sascha Liehr, Liehr.IT <zearom@me.com>
LocalDataStorage may be freely distributed under the MIT license.
*/
function LocalDataStorage(e){function t(e,t){var a=[],r=[];if((void 0!==t||null!==t)&&(r=i(t)),r.length>0)for(var l=0;l<r.length;l++)d[r[l]].LDS_DELETED===!1&&n(r[l],e)&&a.push(r[l]);else for(var l=0;l<d.length;l++)d[l].LDS_DELETED===!1&&n(d[l],e)&&a.push(l);return a}function n(e,t){if(void 0===t||null===t||"function"!=typeof t)return!0;var n=t.call(e);return n}function a(e,t){for(var n={},a=0;a<t.length;a++){var r=t[a];"function"!==r.type&&(n[r.name]=e[r.name])}return n}function r(e,t,n,a){var l=n[a];return"ASC"===l.direction.toUpperCase()&&e[l.name]<t[l.name]||"DESC"===l.direction.toUpperCase()&&e[l.name]>t[l.name]?-1:"ASC"===l.direction.toUpperCase()&&e[l.name]>t[l.name]||"DESC"===l.direction.toUpperCase()&&e[l.name]<t[l.name]?1:a+1<n.length?r(e,t,n,a+1):0}function l(e){return"[object Array]"===Object.prototype.toString.call(e)?!0:!1}function o(e,t){(void 0===t||null===t)&&(t=this);var n=null;"afterDataChanged"===e&&null!==u&&void 0!==u&&(n=u),n.call(t)}function i(e){for(var t=0;t<m.length;t++)if(null!==m[t]&&m[t].name===e)return m[t].rows;return[]}function u(){h&&console.log("Event afterDataChanged started"),v&&v.afterDataChanged(this)}var s="",c="",f=[],d=[],h=!1,g=0,v=null,m=[];this.getId=function(){return s},this.getStructure=function(){return f},this.isDebug=function(){return h},this.getRawRows=function(){return d},this.getPersistencyController=function(){return v},this.setDebug=function(e){h=e},this.addColumn=function(e){if(h&&console.info("LocalDataStorage.addColumn()"),void 0===e.name||null===e.name)throw new Error("Column name can not be null");if("LDS_"===e.name.substring(0,4))throw new Error('Columnprefix "LDS_" is reserved for internal functions');for(var t=0;t<f.length;t++){var n=f[t];if(n.name===e.name)throw new Error('Column "'+e.name+'" already exists')}if(void 0===e.type&&(e.type="string"),"string"!==e.type&&"number"!==e.type&&"boolean"!==e.type)throw new Error('Column "'+e.name+'" does not support datatype "'+e.type+'"');if(void 0!==e.defaultvalue&&null!==e.defaultvalue?"string"===e.type?e.defaultvalue=this.validateValueString(e.defaultvalue):"number"===e.type?e.defaultvalue=this.validateValueNumber(e.defaultvalue):"boolean"===e.type&&(e.defaultvalue=this.validateValueBoolean(e.defaultvalue)):e.defaultvalue=null,void 0!==e.nullable&&null!==e.nullable?e.nullable!==!0&&e.nullable!==!1&&(e.nullable=!0):e.nullable=!0,d.length>0&&null===e.defaultvalue&&!e.nullable)throw new Error('Column "'+e.name+'" is not nullable, and defaultvalue is null.');if(f.push({name:e.name,type:e.type,defaultvalue:e.defaultvalue,nullable:e.nullable}),d.length>0)for(t=0;t<d.length;t++)d[t].LDS_DELETED||(d[t][e.name]=e.defaultvalue);return h&&console.info('Column "'+e.name+'" with type "'+e.type+'" added successfully'),!0},this.addRow=function(e){h&&console.info("LocalDataStorage.addRow()");var t={};if(t.LDS_ROWGUID=this.createRowGuid(),t.LDS_ROWVERSION=this.getCurrentRowVersion(!0),t.LDS_DELETED=!1,void 0!==e&&null!==e)for(var a=0;a<f.length;a++){var r=f[a];void 0!==e[r.name]?"string"===r.type?t[r.name]=this.validateValueString(e[r.name]):"number"===r.type?t[r.name]=this.validateValueNumber(e[r.name]):"boolean"===r.type&&(t[r.name]=this.validateValueBoolean(e[r.name])):r.nullable===!1&&null===r.defaultvalue?console.error('Column "'+r.name+'" can not be null'):t[r.name]=r.defaultvalue}h&&console.info(t);var l=d.length;d.push(t);for(var a=0;a<m.length;a++)n(d[l],m[a].selector)&&m[a].rowList.push(a);try{o("afterDataChanged",this)}catch(i){h&&console.error(i.message)}return!0},this.select=function(e,t,n,a){return this.selectRow(e,t,n,a)},this.selectRow=function(e,n,o,i){var u=[],s=[];o=o||0,void 0===i&&(i=null);for(var c=t(e,i),g=0;g<c.length;g++)s.push(d[c[g]]);if(void 0!==n&&null!==n){if(!l(n)){var v=[];v.push(n),n=v}h&&console.log(n),s.sort(function(e,t){return r(e,t,n,0)})}for(var m=0;m<s.length;m++)(0===o||o>m)&&u.push(a(s[m],f));return u},this.update=function(e,t){return this.updateRow(e,t)},this.updateRow=function(e,n){if(h&&console.info("LocalDataStorage.updateRow()"),!n)throw new Error("data can not be null");for(var a=t(e),r=0,l=0,i=0;i<a.length;i++){for(var u=!1,s=0;s<f.length;s++){var c=n[f[s].name],g=f[s];void 0!==c&&(null===c?f[s].nullable?(d[a[i]][f[s].name]=null,u=!0):console.error('Column "'+g.name+'" can not be null'):"string"===g.type?(d[a[i]][f[s].name]=this.validateValueString(c),u=!0):"number"===g.type?(d[a[i]][f[s].name]=this.validateValueNumber(c),u=!0):"boolean"===g.type&&(d[a[i]][f[s].name]=this.validateValueBoolean(c),u=!0))}u&&(0===l&&(l=this.getCurrentRowVersion(!0)),d[a[i]].LDS_ROWVERSION=l,r++)}if(r>0)try{o("afterDataChanged",this)}catch(v){h&&console.error(v.message)}return r},this.deleteRow=function(e){h&&console.info("LocalDataStorage.deleteRow()");for(var n=t(e),a=0,r=0,l=0;l<n.length;l++){var i={};0===r&&(r=this.getCurrentRowVersion(!0)),i.LDS_ROWGUID=d[n[l]].LDS_ROWGUID,i.LDS_ROWVERSION=r,i.LDS_DELETED=!0,d[n[l]]=i;for(var u=0;u<m.length;u++)if(null!==m[u])e:for(var s=0;s<m[u].rows.length;s++)if(m[u].rows[s]=n[l]){m[u].rows[s]=null;break e}a++}if(a>0)try{o("afterDataChanged",this)}catch(c){h&&console.error(c.message)}return a},this.validateValueString=function(e){return String(e)},this.validateValueNumber=function(e){var t=parseInt(e);return isNaN(t)&&(t=0),t},this.validateValueBoolean=function(e){return"string"==typeof e?e="true"===e.toLowerCase()?!0:"false"===e.toLowerCase()?!1:null:"number"==typeof e?e=1===e?!0:0===e?!1:null:"object"==typeof e&&(e=null),e},this.getCurrentRowVersion=function(e){return e?++g:g},this.createRowGuid=function S(){function e(e){var t=(Math.random().toString(16)+"000000000").substr(2,8);return e?"-"+t.substr(0,4)+"-"+t.substr(4,4):t}return e()+e(!0)+e(!0)+e()},this.createView=function(e,t){for(var n=0;n<m.length;n++)if(null!==m[n]&&m[n].name===e)throw new Error('A view "'+e+'" already exists');return m.push({name:e,selector:t,rows:[]}),!0},this.deleteView=function(e){for(var t=0;t<m.length;t++)if(null!==m[t]&&m[t].name===e)return m[t]=null,!0},this.rebuildView=function(e){for(var n=0;n<m.length;n++)if(null!==m[n]&&m[n].name===e)return m[n].rows=t(m[n].selector),!0;return!1},this.initiate=function(e){if(void 0!==e&&null!==e&&(void 0!==e.id&&null!==e.id&&(s=e.id),void 0!==e.debug&&null!==e.debug&&(h=e.debug),void 0!==e.databasechangeversion&&null!==e.databasechangeversion&&(g=e.databasechangeversion),void 0!==e.enablepersistency&&null!==e.enablepersistency&&e.enablepersistency===!0&&(v=new LocalStoragePersistencyController({debug:e.debug}))),h&&console.info("LocalDataStorage.initiate()"),v)try{var t=v.onInitiate(this);d=t.rows,f=t.structure,g=t.databasechangeversion}catch(n){h&&console.error(n.message)}},this.initiate(e)}function LocalStoragePersistencyController(e){var t=null,n=!1,a=!1;this.isDebug=function(){return a},this.setDebug=function(e){a=e},this.isDataLoadedSucessfully=function(){return n},this.onInitiate=function(e){a&&console.log("LocalStoragePersistencyController.onInitiate");var r,l,o;void 0!==window.localStorage&&null!==window.localStorage&&(t=window.localStorage);var i=t.getItem("LDS_"+e.getId()+"_STRUCTURE"),u=t.getItem("LDS_"+e.getId()+"_ROWS"),s=t.getItem("LDS_"+e.getId()+"_SETTINGS");if(null===i||null===u||null===s)throw new Error("Stored DB-Data are not available");try{r=JSON.parse(i),l=JSON.parse(u),o=JSON.parse(s)}catch(c){throw new Error("Invalid Data - could not reinitialize DB Data")}var f=o.databasechangeversion;return null===t?null:(n=!0,{structure:r,rows:l,databasechangeversion:f})},this.afterDataChanged=function(e){return a&&console.log("LocalStoragePersistencyController.afterDataChanged"),null!==t?(t.setItem("LDS_"+e.getId()+"_STRUCTURE",JSON.stringify(e.getStructure())),t.setItem("LDS_"+e.getId()+"_ROWS",JSON.stringify(e.getRawRows())),t.setItem("LDS_"+e.getId()+"_SETTINGS",JSON.stringify({databasechangeversion:e.getCurrentRowVersion()})),!0):!1},this.initiate=function(e){void 0!==e&&null!==e&&void 0!==e.debug&&null!==e.debug&&(a=e.debug)},this.initiate(e)}module.exports=LocalDataStorage;